<script type="text/ng-template" id="blotter-pasted-text-invalid.html">
  <div class="alert blotter-pasted-text-invalid" role="alert">
    <button ng-show="closeable" type="button" class="close" ng-click="close({$event: $event})">
      <span aria-hidden="true">Ã—</span>
      <span class="sr-only">Close</span>
    </button>

    <pre ng-transclude></pre>
  </div>
</script>


<div class="treasury-upload-allocation-directive-container">

  <uib-accordion>
    <uib-accordion-group is-open="uploadTreasuryAllocation.showPasteForm">
      <uib-accordion-heading>
        <i class="glyphicon"
           ng-class="{'glyphicon-chevron-down': uploadTreasuryAllocation.showPasteForm, 'glyphicon-chevron-right': !uploadTreasuryAllocation.showPasteForm}"></i>
        Copy and paste from blotter excel
      </uib-accordion-heading>

      <uib-alert ng-if="uploadTreasuryAllocation.invalidPastedTextMsg"
                 template-url="blotter-pasted-text-invalid.html"
                 dismiss-on-timeout="25000"
                 close="uploadTreasuryAllocation.closeBlotterPasteAlert()">
        {$uploadTreasuryAllocation.invalidPastedTextMsg$}
      </uib-alert>

      <form ng-show="uploadTreasuryAllocation.showPasteForm" class="form-horizontal" role="form"
            name="pasteBlotterForm">
    <textarea style="height: 350px;" name="pasteBlotterText" id="paste-blotter " class="form-control"
              placeholder="copy and paste from blotter" ng-model="uploadTreasuryAllocation.pastedBlotter"
              ng-change="uploadTreasuryAllocation.onBlotterPasted()"></textarea>
      </form>
    </uib-accordion-group>
  </uib-accordion>

  <div ng-if="uploadTreasuryAllocation.showParsedPastedBid"
       class="bid-table-container bid-table">

    <div ng-if="uploadTreasuryAllocation.showSaveBtn(uploadTreasuryAllocation.tableParams.dataset)"
         class="save-parsed-allocation-btn-container">

      <button class="btn btn-success" ng-disabled="uploadTreasuryAllocation.isSaving"
              ng-click="uploadTreasuryAllocation.saveAllocations(uploadTreasuryAllocation.tableParams.dataset)">
        {$uploadTreasuryAllocation.isSaving ? 'Saving...' : 'Save'$}
        <spinner name="treasuryAllocationSpinner" img-src="{$$root.spinnerImgSrc$}"></spinner>
      </button>
    </div>

    <div class="parsed-pasted-bid-table treasury-allocations-table-display">

      <div ng-class="{'parsed-pasted-bid-table-overlay': uploadTreasuryAllocation.isSaving}"></div>

      <table ng-table="uploadTreasuryAllocation.tableParams"
             class="table table-bordered table-condensed table-responsive table-striped">

        <tbody>
          <tr ng-repeat="allocationObj in $data track by allocationObj.index"
              ng-class="{'pasted-bid-row-matched': allocationObj.original_requests}"
          >

            <td data-title="'S/N'">{$$index + 1$}</td>

            <td title="'DEAL NO'" filter="{deal_number: 'text'}">
              {$::allocationObj.deal_number$}
            </td>

            <td data-title="'SOURCE'" sortable="'source_of_fund'">{$::allocationObj.source_of_fund$}</td>

            <td data-title="'DEAL DATE'" sortable="'deal_date'">
              {$::allocationObj.deal_date | date:'dd-MMM-yyyy'$}
            </td>

            <td data-title="'SETTLEMENT DATE'" sortable="'settlement_date'">
              {$::allocationObj.settlement_date | date:'dd-MMM-yyyy'$}
            </td>

            <td data-title="'TYPE'" sortable="'transaction_type'">{$::allocationObj.transaction_type$}</td>

            <td data-title="'CATEGORY'" sortable="'client_category'" filter="{client_category:'text'}">
              {$ allocationObj.client_category$}
            </td>

            <td data-title="'RATE'" sortable="'naira_rate'">{$::allocationObj.naira_rate $}</td>

            <td data-title="'CCY'" sortable="'currency'" filter="{currency:'text'}">{$::allocationObj.currency $}</td>

            <td data-title="'CUSTOMER NAME'" sortable="'customer_name_no_ref'" filter="{customer_name_no_ref:'text'}">
              {$allocationObj.customer_name_no_ref $}
            </td>

            <td data-title="'REFERENCE'" sortable="'ref'" filter="{ref :'text'}">
              {$allocationObj.ref$}
            </td>

            <td data-title="'CURRENT ALLOCATION'" sortable="'fcy_amount'" filter="{fcy_amount: 'number'}">
              {$::allocationObj.fcy_amount |number:2$}
            </td>

            <td style="min-width: 135px;" data-title="'ORIGINAL REQUEST'" filter="{original_requests :'number'}">
              <span class="original-request-row"
                    ng-repeat="req in allocationObj.original_requests"
                    ng-class="{'multiple-requests': (allocationObj.original_requests.length > 1), 'deleted': (allocationObj.original_requests_deleted[$index] == $index)}">

                {$::req |number:2$}

                <span class="glyphicon remove-add-bid-icons"
                      ng-class="{'glyphicon-remove': (allocationObj.original_requests_deleted[$index] != $index), 'glyphicon-plus-sign': (allocationObj.original_requests_deleted[$index] == $index)}"
                      ng-click="uploadTreasuryAllocation.toggleMapOriginalRequest(allocationObj.index, $index)"></span>
              </span>
            </td>

            <td data-title="'PREVIOUS ALLOCATIONS'" filter="{previous_allocations :'number'}">
              <span class="original-request-row"
                    ng-repeat="req in allocationObj.previous_allocations"
                    ng-class="{'multiple-requests': (allocationObj.original_requests.length > 1), 'deleted': (allocationObj.original_requests_deleted[$index] == $index)}">
                {$::req |number:2$}
              </span>
            </td>

            <td data-title="'PREVIOUS OUTSTANDING'" filter="{previous_outstandings :'number'}">
              <span class="original-request-row"
                    ng-repeat="req in allocationObj.previous_outstandings"
                    ng-class="{'multiple-requests': (allocationObj.original_requests.length > 1), 'deleted': (allocationObj.original_requests_deleted[$index] == $index)}">
                {$::req |number:2$}
              </span>
            </td>

            <td data-title="'CURRENT OUTSTANDING'" sortable="'current_outstandings'">
              <span class="original-request-row" ng-repeat="req in allocationObj.current_outstandings"
                    ng-class="{'multiple-requests': (allocationObj.original_requests.length > 1), 'deleted': (allocationObj.original_requests_deleted[$index] == $index)}">
                {$req |number:2$}
              </span>
            </td>

          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div ng-if="uploadTreasuryAllocation.rejectedDataList" class="bid-table-container">

    <uib-alert template-url="blotter-pasted-text-invalid.html">
      Blotter cannot be saved. Please see reasons below:
    </uib-alert>

    <table class="table table-bordered table-condensed table-responsive table-striped">
      <thead>
        <tr>
          <th>S/N</th>
          <th>DEAL NO</th>
          <th>DEAL DATE</th>
          <th>TYPE</th>
          <th>AMOUNT</th>
          <th>SAVE STATUS</th>
        </tr>
      </thead>

      <tbody>
        <tr ng-repeat="row in uploadTreasuryAllocation.rejectedDataList track by row.index">
          <td>{$$index +1$}</td>
          <td>{$::row.deal_number$}</td>
          <td>{$::row.deal_date$}</td>
          <td>{$::row.transaction_type$}</td>
          <td class="td-number">{$::row.fcy_amount| number:2$}</td>
          <td>
            <span style="color: green;font-weight: 900; font-size: 1.3em;"
                  ng-if="!row.errors">Data ok - can be saved!</span>

            <span style="color: #c7254e;" ng-repeat="rowError in row.errors">
              Cannot be saved: {$rowError$}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
