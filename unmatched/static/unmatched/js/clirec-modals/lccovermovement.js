// Generated by CoffeeScript 1.7.1
(function() {
  var $lcCoverMvmtForm, $lcNumber, $memoAcct, $nostroAcct, $tr, clirecDataObj, dataIsCorrect, lcNumberIsCorrect, memoAcctIsCorrect, memoAcctText, summaryText;
  $lcCoverMvmtForm = $('#clirec-modal-lccovermovement-form');
  memoAcctText = '';
  $lcCoverMvmtForm.on({
    'added': function(evt, pk, uiItem) {
      return memoAcctText = uiItem.label;
    },
    'killed': function() {
      return memoAcctText = '';
    }
  }, '#id_memo_acct_on_deck');
  $tr = $($rowChkBoxSelector).filter(':checked').parents('tr');
  clirecDataObj = getClirecData($tr);
  $lcNumber = $('#id_lc_number').val(clirecDataObj.lcNumber);
  $('#id_amount_text').prop('readonly', true).val(clirecDataObj.amount);
  $('#id_amount').val(kanmii.formattedToNumber(clirecDataObj.amount));
  $('#id_clirec_id').val(clirecDataObj.id);
  $nostroAcct = $('#id_acct');
  $nostroAcct.attr('data-plugin-options', clirecUploadUtils.setPluginInitialVal({
    $el: $nostroAcct,
    text: clirecUploadUtils.nostroObj.number,
    id: clirecUploadUtils.nostroObj.id
  }));
  $memoAcct = $('#id_memo_acct');
  $memoAcct.attr('data-plugin-options', clirecUploadUtils.setPluginInitialVal({
    $el: $memoAcct,
    text: clirecUploadUtils.nostroObj.defaultMemoAcct.number,
    id: clirecUploadUtils.nostroObj.defaultMemoAcct.id
  }));
  summaryText = (function() {
    var absNetAmtFormatted, crAcct, drAcct, selectionSummary, _ref;
    _ref = selectedClirecsEnum(), absNetAmtFormatted = _ref.absNetAmtFormatted, selectionSummary = _ref.selectionSummary;
    if (clirecDataObj.drCr === 'D') {
      drAcct = memoAcctText;
      crAcct = clirecUploadUtils.nostroObj.ledger_acct.number;
    } else {
      drAcct = clirecUploadUtils.nostroObj.ledger_acct.number;
      crAcct = memoAcctText;
    }
    return _.template("<%=selectionSummary%>\n\n%tab%DR%tab%<%-drAcct%>%tab%<%-absNetAmtFormatted%>\n%tab%CR%tab%<%-crAcct%>%tab%<%-absNetAmtFormatted%>", {
      drAcct: drAcct,
      crAcct: crAcct,
      selectionSummary: selectionSummary,
      absNetAmtFormatted: absNetAmtFormatted
    }).replace(/%tab%/g, '\t');
  })();
  $('#id_lc_cvmvmt_clirec_detail').val(summaryText);
  lcNumberIsCorrect = function() {
    return $lcNumber.val() && $lcNumber.val().length > 12;
  };
  memoAcctIsCorrect = function() {
    var ccy;
    if ($memoAcct.val() === clirecUploadUtils.nostroObj.defaultMemoAcct.id) {
      return true;
    }
    if (!/^\d+$/.test($('#id_memo_acct').val())) {
      return false;
    }
    ccy = /MCSH-?([A-Z]{3})/i.exec($('#id_memo_acct_on_deck>div').text());
    if (!ccy || ccy[1] !== clirecUploadUtils.nostroObj.ccy) {
      return false;
    }
    return true;
  };
  dataIsCorrect = function() {
    return lcNumberIsCorrect() && memoAcctIsCorrect();
  };
  return $lcCoverMvmtForm.on({
    'submit': function(evt) {
      evt.preventDefault();
      if (!dataIsCorrect()) {
        return window.alert("Lc Number/Memo account not set or incorrect.");
      } else {
        return $.ajax({
          url: clirecUploadUtils.getModalActionUrl('lccovermovement'),
          data: $(this).serialize(),
          type: 'POST',
          dataType: 'json',
          success: function(resp) {
            if (!resp.form_errors) {
              resp.summaryText = summaryText;
            }
            return processSucceeds($tr, resp);
          },
          error: function(resp) {
            return console.log('Posting for cover movement fails = ', resp);
          }
        });
      }
    }
  });
})();

$(window).trigger('init-autocomplete');
